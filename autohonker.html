<!--
List of all TTS voices:
https://github.com/chrisjp/tts/blob/master/assets/js/tts.js#L10-L66
Test them anywhere
https://lazypy.ro/tts/?voice=2-4-11&service=Oddcast&text=Godverdomme%20heb%20ik%20zin%20om%20een%20zeehond%20in%20elkaar%20te%20knuppelen&lang=Dutch&s=A
-->
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
  <style>
    img {
      top: 0px;
      left: 0px;
      position: absolute;
      padding: 0px 0px 0px 0px;
      margin: 0px 0px 0px 0px;
      /* width: 1280px;
  height: 720px; */
    }
  </style>
</head>

<body>
  <audio id="audio" controls="" style="visibility: hidden;">
    <source id="source" type="audio/mp3">
  </audio>
  <audio id="audio2" controls="" style="visibility: hidden;">
    <source id="source2" type="audio/mp3">
  </audio>
  <img src="overlays/honk.png" id="honkoverlay" style="display:none" />
  <img src="overlays/nederland.png" id="nloverlay" style="display:none;" />
  <img src="overlays/tts.png" id="ttsoverlay" style="display:none" />
  <script type="text/javascript">
    var nlOverlay = document.getElementById('nloverlay');
    var ttsOverlay = document.getElementById('ttsoverlay');
    var honkOverlay = document.getElementById('honkoverlay');
    const elements2 = {
      source: document.querySelector("#source2"),
      audio: document.querySelector("#audio2")
    };
    const elements = {
      source: document.querySelector("#source"),
      audio: document.querySelector("#audio")
    };
    // const TTS_BASE = "https://translate.google.com/translate_tts";
    // const TTS_BASE = "https://api.streamelements.com/kappa/v2/speech";
    const TTS_BASE = "https://cors-anywhere.herokuapp.com/https://lazypy.ro/tts/proxy.php";
    const params = new URLSearchParams(location.search);
    let ttsVoice = params.get("voice") || "Marc";
    let ttsService="Polly";
    // const ttsVoice = params.get("voice") || "Brian";
    var isPlaying = 0;
    let ttsLang = "brit";
    let honkSay = false;
    let audioplay = [];
    let eventQueue = [];
    let msgQueue = [];
    var messageLength = "";
    let ttsTimer = false;
    let nederlands = new Audio('nederland.mp3')
    let honk = '../honk/honk-sound.mp3';
    let because = '../honk/because.wav';
    let honk2 = '../honk/honk2.wav';
    let gossipblue = '../honk/gossipBlue_honk_02.wav';
    let honkb3 = '../honk/ALl/goose_honk_b_03.wav';
    let pylon3 = '../honk/ALl/goose_honk_pylon_03.wav';
    let harmonica2 = '../honk/ALl/goose_honk_harmonica_02.wav';
    let harmonica6 = '../honk/ALl/goose_honk_harmonica_06.wav';
    let soap4 = '../honk/ALl/goose_honk_soap_04.wav';
    let trash3 = '../honk/ALl/goose_honk_trashlid_03.wav';
    let walkie4 = '../honk/ALl/goose_honk_walkie_talkie_04.wav';
    let walkie3 = '../honk/ALl/goose_honk_walkie_talkie_03.wav';
    let honkb6 = '../honk/ALl/goose_honk_b_06.wav';
    let shortsong = [honk, because, honk2, gossipblue, honkb3, pylon3, harmonica2, harmonica6, soap4, trash3, walkie4, walkie3, honkb6];

    var wildrse = '../honk/wild_goose_battle_rubysapph.mp3';
    var wildrby = '../honk/wild_goose_battle.mp3';
    var megalo1 = '../honk/undertale-megalovania-but-its-honked-by-the-goose.mp3';
    var still = '../honk/still_a_goose.mp3';
    var megalo2 = '../honk/MegaHONKvaniaSHORT.mp3';
    var betahonk = '../honk/Goose Honk (Beta Mix) -Untitled Goose Game.mp3';
    var venga = '../honk/vengagoose_we_like_to_party.mp3';
    var toxic = '../honk/toxic_goose.mp3';
    var toss = '../honk/Toss_a_Coin_to_Your_Goose.mp3';
    var mii = '../honk/mii_channel_goose.mp3';
    var nineties = '../honk/HONKING_IN_THE_90s_NOT_WHEN_I_SHIFT_INTO_MAXIMUM_OVERHONK.mp3';
    var battle = '../honk/battle_against_a_true_goose.mp3';
    var duckmoon = '../honk/ducktales_the_moon.mp3';
    var road = '../honk/On the road again.mp3';
    var ghostbusters = '../honk/Ghostbusters.mp3';
    var doom = '../honk/Doom.mp3';
    var miles = '../honk/500_miles.mp3';
    var africa1 = '../honk/Africa by Honkhonk1.mp3';
    var africa2 = '../honk/Africa by Honkhonk2.mp3';
    var caramell = '../honk/Caramelldansen featuring Goose.mp3';
    var cascada = '../honk/Cascada_-_Everytime_We_Honk.mp3';
    var country = '../honk/country_roads.mp3';
    var curb = '../honk/curb_your_engooseiasm.mp3';
    var goosetales = '../honk/goosetales.mp3';
    var smashmouth = '../honk/smash mouth - all star.mp3';
    var vivaldi = '../honk/Vivaldis_Four_Seasons_-_Spring_1_Allegro.mp3';

    var longsong = [wildrse, wildrby, megalo1, still, megalo2, betahonk, venga, toxic, toss, mii, nineties, battle, duckmoon, road, ghostbusters, doom, miles, africa1, africa2, caramell, cascada, country, curb, goosetales, smashmouth, vivaldi];
    //TODO add rickroll

    var everytimef = '../honk/og/Cascada_-_Everytime_We_Honk.wav';
    var curbf = '../honk/og/curb_your_engooseiasm.wav';
    var doomf = '../honk/og/Doom.mp3';
    var duckmoonf = '../honk/og/ducktales_the_moon.mp3';
    var enterf = '../honk/og/Enterprising_Young_Geese.mp3';
    var firef = '../honk/og/fireflies_by_goose_city.mp3';
    var ghostf = '../honk/og/Ghostbusters.mp3';
    var goosef = '../honk/og/goosetales.wav';
    var ninetiesf = '../honk/og/HONKING_IN_THE_90s_NOT_WHEN_I_SHIFT_INTO_MAXIMUM_OVERHONK.mp3';
    var megalo1f = '../honk/og/MegaHONKvania.mp3';
    var miif = '../honk/og/mii_channel_goose.mp3';
    var roadf = '../honk/og/On the road again.mp3';
    var rickf = '../honk/og/Rickroll.mp3';
    var smashf = '../honk/og/smash mouth - all star - a url-hoarder-official property.mp3';
    var stillf = '../honk/og/still_a_goose.mp3';
    var tossf = '../honk/og/Toss_a_Coin_to_Your_Goose.mp3';
    var toxicf = '../honk/og/toxic_goose.mp3';
    var megalo2f = '../honk/og/undertale-megalovania-but-its-honked-by-the-goose.mp3';
    var vengaf = '../honk/og/vengagoose_we_like_to_party.mp3';
    var wildbattlef = '../honk/og/wild_goose_battle.mp3';
    var wildbattlersef = '../honk/og/wild_goose_battle_rubysapph.mp3';
    var caramelf = '../honk/og/Caramelldansen featuring Goose.mp3';
    var battlef = '../honk/og/battle_against_a_true_goose.mp3';
    var milesf = '../honk/og/500_miles.mp3';
    var abbaf = '../honk/og/abba_dancing_queen.wav';
    var countryf = '../honk/og/country_roads.mp3';
    var vivaldif = '../honk/og/Vivaldis_Four_Seasons_-_Spring_1_Allegro.wav';
    var africaf = '../honk/og/Africa by Honkhonk.mp3';
    var fullsong = [everytimef, curbf, doomf, duckmoonf, enterf, firef, ghostf, goosef, ninetiesf, megalo1f, miif, roadf, rickf, smashf, stillf, tossf, toxicf, megalo2f, vengaf, wildbattlef, wildbattlersef, caramelf, battlef, africaf, milesf,
      countryf, vivaldif, abbaf
    ];

    ComfyJS.onCommand = (user, command, message, flags, extra) => {
      checkCommands(user, message, flags, self, extra);
    }

    ComfyJS.onChat = (user, message, flags, self, extra) => {
      checkCommands(user, message, flags, self, extra);
    }

    function checkCommands(user, message, flags, self, extra) {
      switch (extra.customRewardId) {
        case 'e7750cae-582f-43a6-931f-4faed7e1943d':
          break;
        case '231bc4b1-1e68-4779-9b05-04b49cc04822':
          console.log("Short song played");
          eventQueue.push(shortsong[Math.floor(Math.random() * shortsong.length)]);
          overlayTimer(honkOverlay, 0.1, "honktimer", false);
          break;
        case 'fb25b574-6227-40cf-a161-45a2d13cf657':
          console.log("Long song played");
          number = Math.floor(Math.random() * longsong.length);
          // console.log(number);
          eventQueue.push(longsong[number]);
          overlayTimer(honkOverlay, 3, "honktimer", false);
          break;
        case 'ac09e298-9433-42dd-9c98-32a7be6a0d91':
          console.log("Full song played");
          number = Math.floor(Math.random() * longsong.length);
          // console.log(number);
          eventQueue.push(fullsong[number])
          overlayTimer(honkOverlay, 9, "honktimer", false);
          break;
        case '2b698bc6-7fd5-4bb0-94a8-090326dbf1cb':
          console.log("English TTS");
          msgQueue.length = 0;
          ttsVoice = 'Jordan';
          ttsService = "CereProc"
          overlayTimer(ttsOverlay, 6, "ttsTimer", true);
          break;
        case '1911e078-65e1-4833-aeea-2ca7361e5cf3':
          console.log("Dutch TTS activate");
          msgQueue.length = 0;
          // ttsVoice = params.get("voice") || "nl-NL-Wavenet-C";
          ttsVoice = '1-2-11';
          ttsService = "Oddcast"
          overlayTimer(ttsOverlay, 7, "ttsTimer", true);
          break;
          case '9e28f797-e3e5-46de-8bb2-e29f90e72bc6':
            console.log("Japanese TTS activate");
            msgQueue.length = 0;
            ttsVoice = 'Takumi';
            ttsService = "Polly"
            overlayTimer(ttsOverlay, 6, "ttsTimer", true);
            break;
        case '02db1e1d-a2c9-4208-9cd0-94cd6567c1d0':
          console.log("nederlands");
          nederlands.play();
          nlOverlay.style.display = "inline";
          overlayTimer(nlOverlay, 6, "nltimer", false);
      }

      audioController();

      if (!flags.customReward) {
        messageLength = [];
        messageLength = message.split(" ");
        if (message[0].substring(0, 1) !== "!") {
          if (messageLength.length > 20) {
            message = "";
            for (var i = 0; i < 20; i++) {
              message += messageLength[i] + " ";
            }
          }
          msgQueue.push(message.trim());
          playTTS();
        } else {}
      }
    }
    ComfyJS.Init("riekelt");

//The code down here is for playing the honk queue.
    elements.audio.addEventListener('ended', audioController)

    async function audioController() {


      if (audio.paused) {
        if (eventQueue[0] === undefined) {} else {
          elements.source.src = eventQueue[0];
          const audio = elements.audio;

          await timeout(100)
          audio.load()
          audio.volume = 1;
          audio.play()

          eventQueue.shift()
        }
      }
    }

    function timeout(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function randomIntInc(high, low) {
      var returnio = Math.floor(Math.random() * high);
      console.log(returnio);
      return returnio;
    }

    function overlayTimer(overlay, t, kindof, isTTS) {
      overlay.style.display = "inline";
      if (isTTS) {
        ttsTimer = true;
      }
      console.log(kindof + " is true");
      setTimeout(function() {
        console.log(kindof + " is false");
        overlay.style.display = "none";
        if (isTTS) {
          ttsTimer = false;
        }
      }, (t * 10000));
    }

    async function playTTS() {
      if (ttsTimer) {
        // if audio playing, queue
        if (audio2.paused) {
          const str = `service=${ttsService}&voice=${ttsVoice}&text=${encodeURIComponent(msgQueue[0])}`;
          const qs = new URLSearchParams({
            voice: ttsVoice,
            text: msgQueue[0]
          });
          // const qs = new URLSearchParams({
          // total: 1,
          // idx: 0,
          // ie: "UTF-8",
          // textlength: msgQueue[0].length,
          //   tl: "en-GB",
          //   client: "tw-ob",
          //   q: msgQueue[0]
          // });
          let speak = await makeTTSRequest('POST', `${TTS_BASE}?${str}`);
          speak = JSON.parse(speak);
          if (!speak.success) {
            console.log("speak didn't succeed");
            return;
          }
          if (speak.status != 200) {
            console.log("speak isn't 200");
            // await speak.text();
            // return;
          }

          const mp3 = speak.speak_url;
          // const blobUrl = URL.createObjectURL(mp3);
          elements2.source.src = mp3;
          const audio2 = elements2.audio;
          audio2.load();
          audio2.volume = 1;
          audio2.play();
          // remove message from queue
          msgQueue.shift();

        } else {
          // wait 100ms to check audio duration
          await timeout(100)
          setTimeout(playTTS, audio2.duration * 1000 + 100);
        }
      }
    }
    function makeTTSRequest(method, url) {
  return new Promise(function (resolve, reject) {
    let xhr = new XMLHttpRequest();
    xhr.open(method, url);
    xhr.onload = function () {
      if (this.status >= 200 && this.status < 300) {
        resolve(xhr.response);
      } else {
        reject({
          status: this.status,
          statusText: xhr.statusText,
        });
      }
    };
    xhr.onerror = function () {
      reject({
        status: this.status,
        statusText: xhr.statusText,
      });
    };
    xhr.send();
  });
}
  </script>
</body>

</html>
